<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Vehicle Counter Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }
        .live-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #ef4444;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="min-h-screen p-6">
    
    <!-- Navbar -->
    <nav class="flex justify-between items-center mb-8 px-4">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                <i class="fas fa-video text-white"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-white">SmartTraffic <span class="text-blue-500">AI</span></h1>
                <p class="text-xs text-gray-400">Real-time Vehicle Analytics</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="flex items-center gap-2 text-sm text-gray-300 bg-slate-800 px-3 py-1 rounded-full border border-slate-700">
                <span class="live-indicator"></span> LIVE FEED
            </span>
            <div class="text-right">
                <p class="text-sm font-semibold" id="current-time">--:--</p>
                <p class="text-xs text-gray-400" id="current-date">--/--/----</p>
            </div>
        </div>
    </nav>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- Left Column: Video Feed (8 cols) -->
        <div class="lg:col-span-8 space-y-6">
            <div class="glass-panel p-1 relative overflow-hidden group">
                <div class="absolute top-4 left-4 z-10 bg-black/60 backdrop-blur-sm px-3 py-1 rounded text-xs font-mono text-green-400 border border-green-500/30">
                    <i class="fas fa-circle text-[8px] mr-2"></i>SYSTEM ACTIVE
                </div>
                <img id="video-stream" src="{{ url_for('video_feed') }}" class="w-full rounded-lg shadow-2xl border border-slate-700/50" alt="Live Stream">
                
                <!-- Overlay Stats on Hover -->
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 to-transparent p-6 translate-y-full group-hover:translate-y-0 transition-transform duration-300">
                    <div class="flex gap-8">
                        <div>
                            <p class="text-xs text-gray-400 uppercase tracking-wider">Model</p>
                            <p class="text-sm font-semibold text-white">SSD MobileNet V2</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400 uppercase tracking-wider">Resolution</p>
                            <p class="text-sm font-semibold text-white">800x600 px</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400 uppercase tracking-wider">FPS</p>
                            <p class="text-sm font-semibold text-green-400" id="fps-counter">0.0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Stats & Charts (4 cols) -->
        <div class="lg:col-span-4 space-y-6">
            
            <!-- Stream Settings -->
            <div class="glass-panel p-4">
                <h3 class="text-xs font-semibold text-gray-400 mb-3 uppercase tracking-wider border-b border-gray-700 pb-2">Stream Settings</h3>
                <div class="flex gap-2">
                    <input type="text" id="stream-url" placeholder="Enter RTSP/HTTP/File URL..." 
                           class="bg-slate-900/50 border border-slate-600 text-white text-xs rounded focus:ring-blue-500 focus:border-blue-500 block w-full p-2">
                    <button onclick="updateStream()" 
                            class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded text-xs px-4 py-2 transition-colors whitespace-nowrap">
                        <i class="fas fa-sync-alt"></i> Set
                    </button>
                </div>
                <p class="text-[10px] text-gray-500 mt-2">Examples: traffic.mp4, http://ip:port/video</p>
            </div>

            <!-- Total Count Card -->
            <div class="glass-panel p-6 bg-gradient-to-br from-slate-800 to-slate-900 border-l-4 border-l-blue-500">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <p class="text-sm text-gray-400 font-medium uppercase tracking-wider">Total Vehicles</p>
                        <h2 class="text-5xl font-bold text-white mt-2" id="total-count">0</h2>
                    </div>
                    <div class="w-12 h-12 bg-blue-500/10 rounded-full flex items-center justify-center">
                        <i class="fas fa-car text-blue-400 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center gap-2 text-xs text-blue-300 bg-blue-500/10 w-fit px-2 py-1 rounded">
                    <i class="fas fa-arrow-up"></i>
                    <span>Updating live</span>
                </div>
            </div>

            <!-- Vehicle Types Breakdown -->
            <div class="glass-panel p-6">
                <h3 class="text-lg font-semibold text-white mb-4 border-b border-gray-700 pb-2">Traffic Composition</h3>
                <div class="space-y-4">
                    <!-- Car -->
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-300"><i class="fas fa-car-side w-5 text-center"></i> Cars</span>
                            <span class="font-bold" id="count-car">0</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full" style="width: 0%" id="bar-car"></div>
                        </div>
                    </div>
                    <!-- Motorcycle -->
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-300"><i class="fas fa-motorcycle w-5 text-center"></i> Motorcycles</span>
                            <span class="font-bold" id="count-motorcycle">0</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-2">
                            <div class="bg-yellow-500 h-2 rounded-full" style="width: 0%" id="bar-motorcycle"></div>
                        </div>
                    </div>
                    <!-- Bus -->
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-300"><i class="fas fa-bus w-5 text-center"></i> Buses</span>
                            <span class="font-bold" id="count-bus">0</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-2">
                            <div class="bg-purple-500 h-2 rounded-full" style="width: 0%" id="bar-bus"></div>
                        </div>
                    </div>
                    <!-- Truck -->
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-300"><i class="fas fa-truck w-5 text-center"></i> Trucks</span>
                            <span class="font-bold" id="count-truck">0</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-2">
                            <div class="bg-orange-500 h-2 rounded-full" style="width: 0%" id="bar-truck"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mini Chart -->
            <div class="glass-panel p-6">
                <h3 class="text-sm font-semibold text-gray-400 mb-4 uppercase">Activity Trend (Last Min)</h3>
                <canvas id="activityChart" height="150"></canvas>
            </div>
        </div>
    </div>

    <!-- Script for Clock and Data Fetching -->
    <script>
        // Update Clock
        function updateClock() {
            const now = new Date();
            document.getElementById('current-time').innerText = now.toLocaleTimeString();
            document.getElementById('current-date').innerText = now.toLocaleDateString();
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Chart.js Setup
        const ctx = document.getElementById('activityChart').getContext('2d');
        const activityChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(10).fill(''),
                datasets: [{
                    label: 'Vehicles',
                    data: Array(10).fill(0),
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { 
                        display: true, 
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#64748b', font: { size: 10 } } 
                    }
                }
            }
        });

        // Fetch Data from Backend
        async function fetchStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                // Update Total
                document.getElementById('total-count').innerText = data.total_count;
                document.getElementById('fps-counter').innerText = data.fps.toFixed(1);

                // Update Breakdown
                const types = data.class_counts;
                const total = data.total_count || 1; // Avoid division by zero

                // Helper to update bar
                const updateBar = (id, count) => {
                    const elCount = document.getElementById(`count-${id}`);
                    const elBar = document.getElementById(`bar-${id}`);
                    if(elCount && elBar) {
                        elCount.innerText = count;
                        const percent = (count / total) * 100;
                        elBar.style.width = `${percent}%`;
                    }
                };

                updateBar('car', types[3] || 0); // 3 is Car ID
                updateBar('motorcycle', types[4] || 0); // 4 is Motorcycle
                updateBar('bus', types[6] || 0); // 6 is Bus
                updateBar('truck', types[8] || 0); // 8 is Truck

                // Update Chart (Fake trend for demo based on total count change)
                // In real app, backend should send time-series data
                const currentData = activityChart.data.datasets[0].data;
                currentData.shift();
                currentData.push(data.total_count); // Just plotting total count for now
                activityChart.update();

            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }

        async function updateStream() {
            const urlInput = document.getElementById('stream-url');
            const url = urlInput.value.trim();
            if (!url) return alert("Please enter a URL");
            
            const btn = document.querySelector('button[onclick="updateStream()"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                const response = await fetch('/api/update_source', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url }),
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    btn.classList.add('bg-green-600', 'hover:bg-green-700');
                    btn.innerHTML = '<i class="fas fa-check"></i>';
                    
                    // Force reload video stream
                    const videoImg = document.getElementById('video-stream');
                    const currentSrc = videoImg.src.split('?')[0];
                    videoImg.src = currentSrc + '?t=' + new Date().getTime();

                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                        btn.disabled = false;
                        urlInput.value = ''; 
                    }, 2000);
                    
                } else {
                    alert("Error: " + result.message);
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                alert("Failed to connect to server");
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        // Poll stats every 1 second
        setInterval(fetchStats, 1000);
    </script>
</body>
</html>
